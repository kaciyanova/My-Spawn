function parseUri(e){for(var t=parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),s={},n=14;n--;)s[t.key[n]]=r[n]||"";return s[t.q.name]={},s[t.key[12]].replace(t.q.parser,function(e,r,n){r&&(s[t.q.name][r]=n)}),s}function parseQueryStr(e){var t=e.split("&");if(""==t)return{};for(var r={},s=0;s<t.length;++s){var n=t[s].split("=");2==n.length&&(r[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return r}function updateData(e){console.log("Updating data",typeof e),$.ajax({url:countrydata.url+"?auth=t3stF33dAuth&v="+version,dataType:"json",success:function(t,r,s){console.log("Success",t),settings=t.settings,"undefined"==typeof settings.region&&(settings.region=countrydata.ID.toLowerCase()),"undefined"==typeof settings.t&&(settings.t=settings.ctext),"undefined"==typeof settings.bt&&(settings.bt="Get Cashback Now"),"undefined"==typeof settings.ts&&(settings.ts="Your tracking has been set for %n%"),TCBData=JSON.stringify({assetspath:"//"+settings.domain+"/toolbarassets/"+settings.region+"/",hpr:settings.hpr}),merchants=t.merchants,delay=1e3*settings.expiry,clearTimeout(updatetimer),updatetimer=setTimeout(updateData,delay),"function"==typeof e&&e(!0)},error:function(t,r,s){console.log("Error",t,"textStatus: ",r,"errorThrown: ",s),clearTimeout(updatetimer),updatetimer=setTimeout(updateData,6e5),"function"==typeof e&&e(!1)}})}function replaceVars(e,t){for(var r=1,s=arguments.length;s>r;r++){var n=arguments[r];"undefined"==typeof e[n]&&(e[n]=settings[n]),"string"==typeof e[n]&&(e[n]=e[n].replace(/%([A-Z0-9]+)%/gi,function(t,r){return"string"==typeof e[r]?e[r]:"string"==typeof settings[r]?settings[r]:""}))}}function getMerchant(e){if(""!=e){var t=merchants[e];return"undefined"!=typeof t&&(t.done||(replaceVars(t,"t","tt","bt","ts","u"),"undefined"==typeof t.cs&&(t.cs=settings.cs),"undefined"==typeof t.u?t.u="http://"+settings.domain+"/"+t.i+"/?ref=tb":"/"==t.u.substr(0,1)&&(t.u="http://"+settings.domain+t.u),"undefined"==typeof t.rUrl&&(t.rUrl=e),t.done=!0),"undefined"!=typeof merchantclicks[t.i]?(t.trackingset=!0,csdone[t.i]=!0,dismissedmerchants[t.i]=2,delete merchantclicks[t.i]):delete t.trackingset,t.dismissed=dismissedmerchants[t.i]),t}}function handleNavigation(e){if(0==e.frameId){console.log(e);var t=parseUri(e.url),r=t.host,s=getMerchant(r);if("undefined"!=typeof s){if((!s.hcr&&2!=dismissedmerchants[s.i]||s.trackingset)&&chrome.tabs.executeScript(e.tabId,{code:"var TCBData="+TCBData+", TCBMerchant="+JSON.stringify(s)+";",runAt:"document_start"},function(t){console.log("Inserted TCBMerchant",t),"undefined"!=typeof t?(chrome.tabs.executeScript(e.tabId,{file:"jquery.min.js",runAt:"document_start"},function(e){console.log("Inserted jquery.min.js",e)}),chrome.tabs.insertCSS(e.tabId,{file:"notify.css",runAt:"document_start"},function(e){console.log("Inserted notify.css",e)}),chrome.tabs.executeScript(e.tabId,{file:"notify.js",runAt:"document_start"},function(e){console.log("Inserted notify.js",e)})):(console.log("Error",chrome.runtime.lastError),chrome.runtime.lastError)}),s.cs&&settings.li&&!csdone[s.i]){console.log(s.i+" CS loading"),csdone[s.i]=!0;var n,o=$('<iframe src="http://'+settings.domain+"/EarnCashback.aspx?mpurl="+s.i+'&instant=True&notifier=cs"></iframe>');o.load(function(){console.log(s.i+" CS loaded"),clearTimeout(n),n=setTimeout(function(){o.remove(),o=null,console.log(s.i+" CS removed")},2e3)}),$("body").append(o)}}else if(r==settings.domain&&"/redirect.aspx"==t.path){var a=parseQueryStr(t.query);console.log("Clickthrough page",t.query,a);var i=a.mpurl;""!=i&&(merchantclicks[i]=!0)}else if(settings.hsr||"www.google."!=r.substr(0,11)){if("www.topcashback.co.uk"==r)if("/notifierregion"==t.path.substr(0,15)){var c=t.path.substr(15),u="undefined"!=typeof countrydata&&countrydata.ID?"/"+countrydata.ID:"";u==c&&parseQueryStr(t.query).v==version?(chrome.tabs.executeScript(e.tabId,{file:"jquery.min.js",runAt:"document_start"},function(e){console.log("Inserted jquery.min.js",e)}),chrome.tabs.executeScript(e.tabId,{file:"region.js",runAt:"document_start"},function(e){console.log("Inserted region.js",e)})):chrome.tabs.update(e.tabId,{url:countryselurl+u+"?v="+version})}else"/toolbarregion"==t.path.substr(0,14)&&chrome.tabs.update(e.tabId,{url:countryselurl})}else chrome.tabs.executeScript(e.tabId,{code:"var TCBData="+TCBData+";",runAt:"document_start"},function(t){console.log("Inserted TCBData",t),"undefined"!=typeof t?(chrome.tabs.executeScript(e.tabId,{file:"jquery.min.js",runAt:"document_start"},function(e){console.log("Inserted jquery.min.js",e)}),chrome.tabs.insertCSS(e.tabId,{file:"notify.css",runAt:"document_start"},function(e){console.log("Inserted notify.css",e)}),chrome.tabs.executeScript(e.tabId,{file:"sri.js",runAt:"document_start"},function(e){console.log("Inserted sri.js",e)})):(console.log("Error",chrome.runtime.lastError),chrome.runtime.lastError)})}}parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var version=chrome.runtime.getManifest().version,countryselurl="http://www.topcashback.co.uk/notifierregion",countrydata,settings={},merchants={},TCBData="{}",dismissedmerchants={},merchantclicks={},csdone={},updatetimer;countrydata=chrome.storage.local.get("countrydata",function(e){console.log(e),countrydata=e.countrydata,"undefined"!=typeof countrydata?updateData():chrome.tabs.create({url:countryselurl+"?v="+version})}),chrome.webNavigation.onCommitted.addListener(handleNavigation),chrome.tabs.onReplaced.addListener(function(e,t){console.log("Tab replaced",e,t),chrome.tabs.get(e,function(e){console.log(e),handleNavigation({frameId:0,tabId:e.id,url:e.url})})}),chrome.runtime.onMessage.addListener(function(e,t,r){var s=e.cmd;if("mdata"==s)r(getMerchant(e.host)||null);else if("dismiss"==s)dismissedmerchants[e.i]=2,console.log(e.i+" dismissed");else if("minimise"==s)dismissedmerchants[e.i]=1,console.log(e.i+" minimised");else if("restore"==s)delete dismissedmerchants[e.i],console.log(e.i+" restored");else if("countrysel"==s&&(clearTimeout(updatetimer),countrydata=e.countrydata,console.log("New country data",countrydata),chrome.storage.local.set({countrydata:countrydata}),"undefined"!=typeof countrydata)){var n=t.tab.id;chrome.tabs.sendMessage(n,{tcbstatus:"loading"}),updateData(function(e){e?chrome.tabs.update(n,{url:"http://"+settings.domain+"/notifiersuccess?v="+version}):chrome.tabs.sendMessage(n,{tcbstatus:"loadfail"})})}});