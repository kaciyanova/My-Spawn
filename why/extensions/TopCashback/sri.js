function shiftPage(e){if(e!=shifted){var t=(new Date).getMilliseconds();e?(fixedElements=$("*").filter(function(){var e=$(this),t=e.css("position");if("fixed"===t)return!0;if("absolute"===t){var n=!1;return e.parents().each(function(){var e=$(this).css("position");return"fixed"===e||"absolute"===e||"relative"===e?(n=!0,!1):void 0}),n?!1:!0}return!1}),fixedElements.css("margin-top","+=31"),$body.css("margin-top","+=31")):($body.css("margin-top","-=31"),fixedElements.css("margin-top","-=31"),fixedElements=null),shifted=e,console.log("Page shifted in "+((new Date).getMilliseconds()-t)+" ms"),fixedElements&&console.log(fixedElements.length+" fixed elements")}}function setBanner(){console.log("Setting banner now"),notifydismissed||(html=bannerparts.join(" | "),""!=html?(null==tcbnotify&&(tcbnotify=$('<div id="tcbnotify"><img src="'+TCBData.assetspath+'new/ribbon_logo.png" class="tcb_logo"><span id="tcbnotifycontent"></span><span class="tcbclose">X</span></div>'),tcbnotifycontent=tcbnotify.find("#tcbnotifycontent"),tcbnotify.find(".tcbclose").click(function(){shiftPage(!1),tcbnotify.remove(),tcbnotify=null,tcbnotifycontent=null,notifydismissed=!0}),shiftPage(!0),tcbnotify.insertBefore($body)),tcbnotifycontent.html(html)):null!=tcbnotify&&(shiftPage(!1),tcbnotify.remove(),tcbnotify=null,tcbnotifycontent=null)),console.log("Clearing banner 2"),bannerparts=[],merchantsdone={}}function getMerchantData(e,t){var n=merchantdata[e];if("undefined"!=typeof n)console.log("Merchant data found for "+e),t(n);else{console.log("Merchant data not found for "+e);var o=merchantcallbacks[e];"undefined"!=typeof o?(console.log("Adding callback for "+e),o.push(t)):(console.log("Creating callbacks for "+e),merchantcallbacks[e]=[t],chrome.runtime.sendMessage({cmd:"mdata",host:e},function(t){t&&"undefined"==typeof t.tt&&(t.tt=t.t.replace(/(<([^>]+)>)/gi,"")),merchantdata[e]=t,console.log("Merchant data saved for "+e),$.each(merchantcallbacks[e],function(){this(t)}),delete merchantcallbacks[e]}))}}function processLinks(e,t){var n=!1,o=!1,a=function(){console.log("Waiting: "+waitingcount),o&&n&&(clearTimeout(bannertimeout),0==waitingcount&&(console.log("Setting banner",bannerparts.length),bannertimeout=setTimeout(setBanner,0)))},s=function(){var e=this.hostname;if(""!=e&&e!=winhost){n=!0;var o=$(this),s=t;waitingcount++,getMerchantData(e,function(e){e&&(console.log("Stage "+s,"mdata",e),e.hsr||2!=s&&e.hpr||o.before('<a href="'+e.u+'" title="'+e.tt+'" target="_blank" data-tcbdone="1"><img src="'+TCBData.assetspath+'new/logo19.png" style="margin-bottom: -3px;"></a> '),merchantsdone[e.i]||(e.hrb||"undefined"==typeof e.c||bannerparts.push('<a href="'+e.u+'" target="_blank">'+e.n+" - "+e.c+" cashback</a>"),merchantsdone[e.i]=!0)),waitingcount--,a()}),o.attr("data-tcbdone",1)}};console.log("Stage: "+t),"undefined"==typeof e?(console.log("Clearing banner"),bannerparts=[],merchantsdone={},TCBData.hpr||(t=1,$(elementqueryads,"#taw").each(s)),t=2,$(elementquery,"#search").each(s),TCBData.hpr||(t=3,$(elementqueryads,"#bottomads").each(s),t=4,$(elementqueryads,"#rhscol").each(s))):$(2==t?elementquery:elementqueryads,e).each(s),o=!0,a()}var $body,bodyMargin,fixedElements,shifted=!1,tcbnotify,tcbnotifycontent,bannerparts=[],merchantsdone={},bannertimeout,elementquery='h3.r a[href!=""][data-tcbdone!=1]',elementqueryads='li.ads-ad h3 > a[href!=""][data-tcbdone!=1]',waitingcount=0,notifyshowing=!1,notifydismissed=!1,winhost=window.location.host,merchantdata={},merchantcallbacks={};$(document).ready(function(){$body=$("body"),processLinks();var e=window.MutationObserver||window.WebKitMutationObserver;if(e)new e(function(e){for(var t=e.length,n=0;t>n;n++){var o=e[n].target;"taw"==o.id?(console.log(e[n]),console.log("Match top ads"),TCBData.hpr||processLinks(o,1)):"search"==o.id?(console.log(e[n]),console.log("Match search"),processLinks(o,2)):TCBData.hpr||("bottomads"==o.id?(console.log(e[n]),console.log("Match bottom ads"),processLinks(o,3)):"rhscol"==o.id&&(console.log(e[n]),console.log("Match side ads"),processLinks(o,4)))}}).observe(document.getElementById("main"),{childList:!0,subtree:!0});else{var t=function(){setTimeout(processLinks,1e3)};$(window).on("hashchange",t),""!=window.location.hash&&t()}});